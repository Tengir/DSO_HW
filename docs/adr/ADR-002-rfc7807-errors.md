## ADR-002: RFC7807-совместный формат ошибок

### Context

Сейчас в проекте уже есть единый формат ошибок: `{"error": {"code": "...", "message": "..."}}`.
Это соответствует **NFR-04**: один формат, без stack trace и внутренних деталей.

При этом в стандарте **RFC 7807** описан формат *problem details* (`type`, `title`, `status`, `detail`, `instance`),
который часто используют REST API. Хотелось бы:
- не сломать текущие тесты и NFR-04;
- при этом сделать ошибки более стандартными и удобными для интеграций в будущем.

### Decision

Переходим на **RFC7807-совместный** формат *внутри* поля `error`, но сохраняем обратную совместимость:

- Корневой объект остаётся тем же: всегда есть поле `error`;
- Внутри `error` добавляем поля из RFC7807: `type`, `title`, `status`, `detail`, `instance`;
- Поле `code` **оставляем**, чтобы не ломать существующие тесты и NFR;
- Для валидационных ошибок добавляем `details` с описанием проблем.

Пример для 422:

```json
{
  "error": {
    "type": "about:blank",
    "title": "Validation error",
    "status": 422,
    "detail": "payload validation failed",
    "code": "validation_error",
    "details": [...]
  }
}
```

Реализация:
- создаём модуль `app/errors.py` с функцией-конструктором problem details;
- используем этот модуль в обработчиках `ApiError`, `HTTPException`, `RequestValidationError` в `app/main.py`.

### Consequences

Плюсы:
- Сохраняем совместимость с текущими тестами и фронтом (есть `error.code`);
- Структура ошибок становится ближе к стандарту RFC7807, проще интегрироваться с внешними клиентами;
- Легче добавлять новые типы ошибок — достаточно выбирать `type` и `code`.

Минусы:
- Ответы становятся немного «толще» (больше полей);
- Формат не на 100% совпадает с RFC7807 (есть обёртка `error` и поле `code`).

### Security impact

Положительное влияние:
- Укрепляем **NFR-04**: все ошибки возвращаются в предсказуемом формате;
- Уменьшаем риск **R-03** (утечка внутренних деталей через stack trace): ошибки централизованно проходят через один обработчик;
- Проще искать и логировать ошибки, так как структура единая.

Ограничения:
- Стандарт не защищает сам по себе, всё равно нужно следить, чтобы в `detail` и `title` не попадали чувствительные данные;
- Для логирования по-прежнему нужны отдельные механизмы (NFR-08), здесь мы только описываем структуру ответа.

### Links

- **NFR:** NFR-03 (валидация), NFR-04 (единый формат ошибок).
- **STRIDE:** строка для F26–F30 (Information Disclosure через ошибки).
- **RISKS:** R-03 (утечка внутренних деталей через stack trace).
- **Код:** `app/errors.py`, обработчики ошибок в `app/main.py`.
- **Тесты:** `test_create_deck_validation_error`, `test_validation_error_uses_problem_details`.
