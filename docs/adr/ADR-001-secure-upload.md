## ADR-001: Secure upload для импорта колод

### Context

В будущем сервису нужны загрузки файлов (импорт колод из CSV/JSON и т.п.).
По модели угроз у нас есть риски:
- **R-04** — попытки инъекций через входные данные;
- **R-08** — DoS за счёт очень больших файлов.

Также в **STRIDE** для потоков создания ресурсов (F8, F10) мы отмечали угрозы Tampering и DoS.
При этом проект учебный, поэтому сейчас не хочется тащить сложные решения (антивирус, отдельный сервис загрузок и т.п.).
Нужен простой и понятный механизм, который:
- ограничивает размер файла;
- ограничивает допустимые типы файлов;
- удобно вызывать из эндпоинтов.

### Decision

Сделать отдельный небольшой модуль `app/secure_upload.py` с функцией валидации файла перед обработкой.

Основные правила:
- проверяем **размер файла** (по умолчанию до нескольких мегабайт);
- разрешаем только **белый список MIME-типов** (например, `text/csv`, `application/json`);
- при нарушении правил выбрасываем понятную исключительную ситуацию (ошибка валидации).

Функция будет использовать настройки из `app/config.py` (лимит размера и список типов), чтобы не хардкодить числа в коде.
Эндпоинты при добавлении импорта смогут сначала вызывать `validate_upload(file)`, и только потом парсить содержимое.

### Consequences

Плюсы:
- Простая реализация, понятная на уровне курса;
- Контроль размера и типа файла в одном месте, без копирования логики по эндпоинтам;
- Можно легко добавить новые типы файлов или изменить лимит через конфиг.

Минусы и ограничения:
- Нет проверки содержимого файла (антивирус, сигнатуры и т.п.) — это сознательно оставляем за рамками практики;
- Лимиты единые для всего приложения, тонкой настройки по пользователям нет;
- При необходимости более гибкой логики (разные лимиты для разных эндпоинтов) придётся расширять интерфейс функции.

### Security impact

Положительное влияние:
- Снижаем риск **R-08** (DoS большими файлами) — слишком большие файлы отклоняются ещё до обработки;
- Небольшое снижение риска **R-04** — мы фильтруем хотя бы тип и размер, а не даём грузить произвольный бинарный мусор;
- Поведение валидации предсказуемо и прозрачно (ошибка приходит в едином формате через общий обработчик).

Ограничения:
- Модуль не решает задачи антивирусной проверки и защиты от сложных атак на парсер;
- Для полноты защиты импортирующий код всё равно должен корректно валидировать данные (это покрывается **NFR-03**).

### Links

- **NFR:** NFR-03 (валидация данных), NFR-06 (ограничение DoS по запросам — частично, на уровне размера файла).
- **STRIDE:** строки про F8/F10 (Tampering, DoS при создании ресурсов).
- **RISKS:** R-04 (инъекции через данные), R-08 (перегрузка сервиса).
- **Код:** `app/secure_upload.py`, `app/config.py`.
- **Тесты:** `test_secure_upload_accepts_small_allowed_file`, `test_secure_upload_rejects_too_big_file`, `test_secure_upload_rejects_disallowed_content_type`.
