# Нефункциональные требования (NFR)

## NFR-01: Производительность API

**Описание:** Все API endpoints должны отвечать быстро, чтобы пользователь не ждал при работе с карточками.

**Метрика:** 95-й перцентиль времени ответа ≤ 200 мс для всех GET/POST запросов (кроме импорта больших файлов).

**Порог:** Если больше 5% запросов превышают 200 мс — это проблема.

**Приоритет:** Must

**Обоснование:** Пользователи работают с карточками часто, долгие задержки мешают обучению. FastAPI обычно справляется, но нужно следить за БД-запросами.

---

## NFR-02: Owner-only доступ

**Описание:** Пользователь может получать и изменять только свои колоды и карточки. Попытка доступа к чужим ресурсам должна блокироваться.

**Метрика:** 100% запросов к ресурсам проверяют `owner_id` или роль `admin`. IDOR-атаки возвращают 403.

**Порог:** Ноль успешных запросов к чужим ресурсам.

**Приоритет:** Must

**Обоснование:** Это базовая безопасность. Если пользователь увидит чужие колоды — это утечка данных. Тесты должны проверять IDOR-сценарии.

---

## NFR-03: Валидация входных данных

**Описание:** Все данные от пользователя проверяются до обработки. Некорректные данные отклоняются с понятной ошибкой.

**Метрика:** 100% входных данных проходят валидацию через Pydantic схемы. Невалидные запросы возвращают 422 с кодом `validation_error`.

**Порог:** Ноль невалидированных данных в бизнес-логику.

**Приоритет:** Must

**Обоснование:** Защита от инъекций, переполнений, некорректных данных. Pydantic делает это автоматически, но нужно покрыть все endpoints.

---

## NFR-04: Единый формат ошибок

**Описание:** Все ошибки API возвращаются в одном формате, без stack trace и внутренних деталей.

**Метрика:** 100% ошибок возвращаются в формате `{"error": {"code": "...", "message": "..."}}`. Stack trace никогда не попадает в ответ.

**Порог:** Ноль ответов с stack trace или внутренними путями файлов.

**Приоритет:** Must

**Обоснование:** Stack trace раскрывает структуру проекта и может помочь атакующему. Пользователю он не нужен, а разработчику — в логах.

---

## NFR-05: Хеширование паролей

**Описание:** Пароли пользователей хранятся в виде хешей, не в открытом виде. Используется bcrypt или argon2.

**Метрика:** 100% паролей хранятся как хеши. Минимальная стоимость bcrypt ≥ 12 раундов.

**Порог:** Ноль паролей в открытом виде в БД или логах.

**Приоритет:** Must

**Обоснование:** Если БД утечёт, пароли должны быть защищены. Bcrypt с достаточной стоимостью делает брутфорс очень медленным.

---

## NFR-06: Rate limiting на логин

**Описание:** Endpoint `/auth/login` защищён от брутфорса. После N неудачных попыток аккаунт блокируется на время.

**Метрика:** После 5 неудачных попыток логина с одного IP — блокировка на 15 минут. События логируются.

**Порог:** Максимум 5 попыток в минуту с одного IP.

**Приоритет:** Must

**Обоснование:** Без rate limiting злоумышленник может подбирать пароли. 5 попыток — разумный баланс между безопасностью и удобством.

---

## NFR-07: Производительность БД

**Описание:** Запросы к базе данных выполняются быстро, даже при росте количества колод и карточек.

**Метрика:** Запрос списка колод пользователя (до 1000 колод) выполняется ≤ 100 мс. Запрос карточек для повторения (до 100 карточек) ≤ 50 мс.

**Порог:** Если запросы начинают занимать больше — нужны индексы или оптимизация.

**Приоритет:** Should

**Обоснование:** Пользователь может накопить много колод. Без индексов на `owner_id` и `deck_id` запросы будут тормозить. SQLite для начала ок, но нужно следить.

---

## NFR-08: Логирование запросов

**Описание:** Каждый HTTP-запрос логируется с `request_id` для отслеживания проблем.

**Метрика:** 100% запросов логируются в формате JSON с полями: `ts`, `level`, `request_id`, `method`, `path`, `status`, `duration_ms`, `user_id` (если есть).

**Порог:** Ноль запросов без логов.

**Приоритет:** Should

**Обоснование:** Нужно для отладки и расследований. `request_id` помогает связать логи одного запроса. Пароли и токены в логи не попадают.

---

## NFR-09: Доступность сервиса

**Описание:** API должен быть доступен большую часть времени, без частых падений.

**Метрика:** Uptime ≥ 99% в рабочее время (с 8:00 до 22:00 по МСК). Ошибки 5xx < 1% от всех запросов.

**Порог:** Если uptime падает ниже 99% или 5xx > 1% — нужно разбираться.

**Приоритет:** Should

**Обоснование:** Для учебного проекта 99% достаточно. В продакшене обычно требуют 99.9%, но мы не на этом этапе.

---

## NFR-10: Секреты в переменных окружения

**Описание:** Все секреты (JWT ключи, пароли БД, API ключи) хранятся в переменных окружения, не в коде.

**Метрика:** 100% секретов читаются из env vars. В репозитории нет хардкода секретов.

**Порог:** Ноль секретов в коде или конфигах, которые коммитятся.

**Приоритет:** Must

**Обоснование:** Если секреты в коде — они попадут в git и могут утечь. Pre-commit hooks и CI должны сканировать на секреты (gitleaks).
