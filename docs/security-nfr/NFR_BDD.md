# BDD сценарии для проверки NFR

Сценарии в формате Gherkin для проверки нефункциональных требований.

---

## Сценарий 1: Проверка owner-only доступа (NFR-02)

```gherkin
Feature: Owner-only доступ к ресурсам
  Как пользователь системы
  Я хочу, чтобы только я мог видеть свои колоды
  Чтобы мои данные были защищены

  Scenario: Попытка доступа к чужой колоде должна вернуть 403
    Given есть пользователь "alice" с колодой "deck-123"
    And есть пользователь "bob" с токеном доступа
    When "bob" отправляет GET запрос на "/api/v1/decks/deck-123"
    Then ответ должен иметь статус 403
    And ответ должен содержать код ошибки "forbidden"
    And ответ должен содержать сообщение о запрете доступа
    And "bob" не должен видеть данные колоды "deck-123"
```

---

## Сценарий 2: Валидация входных данных (NFR-03)

```gherkin
Feature: Валидация данных при создании колоды
  Как пользователь системы
  Я хочу получать понятные ошибки при неверных данных
  Чтобы исправить ошибки ввода

  Scenario: Создание колоды с пустым названием отклоняется
    Given пользователь авторизован
    When пользователь отправляет POST "/api/v1/decks" с данными:
      | title | description | source_lang | target_lang |
      |       | Test deck    | en          | ru          |
    Then ответ должен иметь статус 422
    And ответ должен содержать код ошибки "validation_error"
    And ответ должен содержать детали ошибки для поля "title"
    And колода не должна быть создана в базе данных
```

---

## Сценарий 3: Единый формат ошибок (NFR-04)

```gherkin
Feature: Единый формат ошибок API
  Как разработчик или пользователь
  Я хочу видеть ошибки в одном формате
  Чтобы легко их обрабатывать

  Scenario: Любая ошибка возвращается в стандартном формате
    Given пользователь отправляет некорректный запрос
    When происходит ошибка (валидация, не найдено, запрещено)
    Then ответ должен иметь структуру:
      """
      {
        "error": {
          "code": "<код ошибки>",
          "message": "<сообщение>"
        }
      }
      """
    And ответ НЕ должен содержать stack trace
    And ответ НЕ должен содержать пути к файлам проекта
    And ответ НЕ должен содержать внутренние детали реализации
```

---

## Сценарий 4: Rate limiting на логин (NFR-06)

```gherkin
Feature: Защита от брутфорса на логине
  Как система безопасности
  Я хочу блокировать множественные попытки входа
  Чтобы защитить аккаунты пользователей

  Scenario: Блокировка после 5 неудачных попыток логина
    Given есть пользователь "alice" с паролем "correct_password"
    When с IP "192.168.1.100" отправляется 5 POST запросов на "/auth/login" с неверным паролем
    Then первые 5 запросов должны вернуть статус 401
    And 6-й запрос должен вернуть статус 429 (Too Many Requests)
    And ответ должен содержать сообщение о блокировке
    And последующие запросы с этого IP должны быть заблокированы на 15 минут
    And события неудачных попыток должны быть залогированы
```

---

## Сценарий 5: Производительность API (NFR-01)

```gherkin
Feature: Быстрый отклик API
  Как пользователь системы
  Я хочу, чтобы API отвечал быстро
  Чтобы не ждать при работе с карточками

  Scenario: Запрос списка колод выполняется быстро
    Given пользователь "alice" имеет 100 колод
    And пользователь авторизован
    When пользователь отправляет GET "/api/v1/decks"
    Then ответ должен быть получен за время ≤ 200 мс (95-й перцентиль)
    And ответ должен содержать список всех колод пользователя
    And статус ответа должен быть 200

  Scenario: Запрос карточек для повторения выполняется быстро
    Given есть колода "deck-123" с 50 карточками для повторения
    And пользователь авторизован
    When пользователь отправляет GET "/api/v1/decks/deck-123/review"
    Then ответ должен быть получен за время ≤ 200 мс
    And ответ должен содержать список карточек для повторения
```

---

## Сценарий 6: Хеширование паролей (NFR-05)

```gherkin
Feature: Безопасное хранение паролей
  Как система безопасности
  Я хочу хранить пароли в захешированном виде
  Чтобы защитить их при утечке базы данных

  Scenario: Пароль хранится как хеш, не в открытом виде
    Given пользователь регистрируется с паролем "my_secret_password"
    When пароль сохраняется в базе данных
    Then в базе данных НЕ должно быть строки "my_secret_password"
    And в базе данных должен быть bcrypt хеш пароля
    And стоимость bcrypt должна быть ≥ 12 раундов
    And при логине с правильным паролем проверка должна пройти успешно
    And при логине с неправильным паролем проверка должна вернуть 401
```
